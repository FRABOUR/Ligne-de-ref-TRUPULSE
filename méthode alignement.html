<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Projection orthogonale avec incertitudes</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, select { margin-bottom: 5px; width: 100px; }
    #canvas { border: 1px solid #ccc; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Projection orthogonale avec incertitudes</h2>

  <label>Angle A <input type="number" id="angleA" /></label>
  <label>Distance A (m) <input type="number" id="distA" /></label>

  <label>Angle C <input type="number" id="angleC" /></label>
  <label>Distance C (m) <input type="number" id="distC" /></label>

  <label>Unité des angles :
    <select id="angleUnite">
      <option value="deg">Degrés</option>
      <option value="gon">Gon</option>
    </select>
  </label>

  <label>Incertitude angulaire <input type="number" id="sigmaAngle" step="0.01" value="0.1" /></label>
  <label>Incertitude distance (m) <input type="number" id="sigmaDist" step="0.01" value="0.1" /></label>

  <label><input type="checkbox" id="useUncertainty" checked /> Prendre en compte les incertitudes</label>

  <button onclick="calculer()">Calculer</button>

  <div id="resultats" style="margin-top: 20px;"></div>

  <canvas id="canvas" width="600" height="600"></canvas>

  <script>
    function toRadians(angle, unit) {
      return unit === "gon" ? angle * Math.PI / 200 : angle * Math.PI / 180;
    }

    function calculer() {
      const angleUnite = document.getElementById("angleUnite").value;
      const angleA = parseFloat(document.getElementById("angleA").value);
      const distA = parseFloat(document.getElementById("distA").value);
      const angleC = parseFloat(document.getElementById("angleC").value);
      const distC = parseFloat(document.getElementById("distC").value);
      const sigmaAngle = parseFloat(document.getElementById("sigmaAngle").value);
      const sigmaDist = parseFloat(document.getElementById("sigmaDist").value);
      const useUncertainty = document.getElementById("useUncertainty").checked;
      const porteeAB = 300;

      const angleA_rad = toRadians(angleA, angleUnite);
      const angleC_rad = toRadians(angleC, angleUnite);

      const A = { x: distA * Math.cos(angleA_rad), y: distA * Math.sin(angleA_rad) };
      const C = { x: distC * Math.cos(angleC_rad), y: distC * Math.sin(angleC_rad) };

      const dirAB = { x: Math.cos(angleA_rad), y: Math.sin(angleA_rad) };
      const B = { x: A.x + dirAB.x * porteeAB, y: A.y + dirAB.y * porteeAB };

      const AB = { x: B.x - A.x, y: B.y - A.y };
      const AC = { x: C.x - A.x, y: C.y - A.y };
      const ab2 = AB.x ** 2 + AB.y ** 2;
      const t = (AC.x * AB.x + AC.y * AB.y) / ab2;
      const proj = { x: A.x + t * AB.x, y: A.y + t * AB.y };

      const dx = proj.x - C.x;
      const dy = proj.y - C.y;
      const distance = Math.sqrt(dx ** 2 + dy ** 2);

      let texte = `<p>Distance orthogonale : ${distance.toFixed(3)} m</p>`;

      if (useUncertainty) {
        const N = 10000;
        const mc = monteCarloSimulations(N, angleUnite, angleA, distA, angleC, distC, sigmaAngle, sigmaDist, porteeAB);
        texte += `<p>Estimation par Monte Carlo : ${mc.moyenne.toFixed(3)} ± ${mc.ecartType.toFixed(3)} m</p>`;
      }

      document.getElementById("resultats").innerHTML = texte;
      dessiner(A, B, C, proj);
    }

    function monteCarloSimulations(N, angleUnite, angleA, distA, angleC, distC, sigmaAngle, sigmaDist, porteeAB) {
      function randNorm() {
        let u = 0, v = 0;
        while (u === 0) u = Math.random();
        while (v === 0) v = Math.random();
        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
      }

      const distances = [];

      for (let i = 0; i < N; i++) {
        const aA = angleA + sigmaAngle * randNorm();
        const dA = distA + sigmaDist * randNorm();
        const aC = angleC + sigmaAngle * randNorm();
        const dC = distC + sigmaDist * randNorm();
        const pAB = porteeAB; // constante

        const aA_rad = toRadians(aA, angleUnite);
        const aC_rad = toRadians(aC, angleUnite);

        const A = { x: dA * Math.cos(aA_rad), y: dA * Math.sin(aA_rad) };
        const C = { x: dC * Math.cos(aC_rad), y: dC * Math.sin(aC_rad) };

        const dirAB = { x: Math.cos(aA_rad), y: Math.sin(aA_rad) };
        const B = { x: A.x + dirAB.x * pAB, y: A.y + dirAB.y * pAB };

        const AB = { x: B.x - A.x, y: B.y - A.y };
        const AC = { x: C.x - A.x, y: C.y - A.y };
        const ab2 = AB.x ** 2 + AB.y ** 2;
        const t = (AC.x * AB.x + AC.y * AB.y) / ab2;
        const proj = { x: A.x + t * AB.x, y: A.y + t * AB.y };

        const dx = proj.x - C.x;
        const dy = proj.y - C.y;
        distances.push(Math.sqrt(dx ** 2 + dy ** 2));
      }

      const moyenne = distances.reduce((sum, d) => sum + d, 0) / N;
      const variance = distances.reduce((sum, d) => sum + (d - moyenne) ** 2, 0) / N;
      return { moyenne, ecartType: Math.sqrt(variance) };
    }

    function dessiner(A, B, C, P) {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const offsetX = canvas.width / 2;
      const offsetY = canvas.height / 2;
      const scale = 1;

      function drawPoint(pt, color, label) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(offsetX + pt.x * scale, offsetY - pt.y * scale, 4, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillText(label, offsetX + pt.x * scale + 5, offsetY - pt.y * scale - 5);
      }

      function drawLine(p1, p2, color) {
        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(offsetX + p1.x * scale, offsetY - p1.y * scale);
        ctx.lineTo(offsetX + p2.x * scale, offsetY - p2.y * scale);
        ctx.stroke();
      }

      drawLine(A, B, "#000");
      drawLine(C, P, "red");
      drawPoint(A, "black", "A");
      drawPoint(B, "black", "B");
      drawPoint(C, "blue", "C");
      drawPoint(P, "red", "P");
    }
  </script>
</body>
</html>
