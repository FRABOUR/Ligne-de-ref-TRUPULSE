<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Distance d'un point à une droite + Dessin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    canvas {
      border: 1px solid #000;
      background-color: #f8f8f8;
    }
    label, input, select {
      margin: 5px;
    }
    #resultat {
      font-weight: bold;
      color: darkblue;
    }
  </style>
</head>
<body>
  <h2>Distance d'un point à une droite + Visualisation version 0.2 </h2>

  <div>
    <label>Angle à l'accrochage de gauche A : <input type="number" id="angleA" step="0.01"></label>
    <label>Distance horizontale accrochage gauche A : <input type="number" id="distA" step="0.01"></label><br>
    <label>Angle à l'accrochage de droite B : <input type="number" id="angleB" step="0.01"></label>
    <label>Distance horizontale accrochage droite B : <input type="number" id="distB" step="0.01"></label><br>
    <label>Angle point visé C : <input type="number" id="angleC" step="0.01"></label>
    <label>Distance horizontale point visé C : <input type="number" id="distC" step="0.01"></label><br>
    <label>Unité des angles :
      <select id="angleUnite">
        <option value="deg">degrés (°)</option>
        <option value="grad" selected>grades (gon)</option>
      </select>
    </label><br>
    <button onclick="calculer()">Calculer</button>
    <button onclick="exporterPNG()">Exporter en PNG</button>
  </div>

  <p>Distance de C à la droite AB : <span id="resultat">-</span> m</p>
  <canvas id="canvas" width="600" height="600"></canvas>

  <script>
    function degToRad(val, unit) {
      return unit === "grad" ? val * Math.PI / 200 : val * Math.PI / 180;
    }

    function polarToCartesian(angle, distance, unit) {
      const rad = degToRad(angle, unit);
      return {
        x: distance * Math.cos(rad),
        y: distance * Math.sin(rad)
      };
    }

    function projeterPointSurDroite(A, B, C) {
      const ABx = B.x - A.x;
      const ABy = B.y - A.y;
      const ACx = C.x - A.x;
      const ACy = C.y - A.y;
      const t = (ACx * ABx + ACy * ABy) / (ABx * ABx + ABy * ABy);
      return {
        x: A.x + t * ABx,
        y: A.y + t * ABy
      };
    }

    function calculer() {
      const angleA = parseFloat(document.getElementById("angleA").value);
      const distA = parseFloat(document.getElementById("distA").value);
      const angleB = parseFloat(document.getElementById("angleB").value);
      const distB = parseFloat(document.getElementById("distB").value);
      const angleC = parseFloat(document.getElementById("angleC").value);
      const distC = parseFloat(document.getElementById("distC").value);
      const unit = document.getElementById("angleUnite").value;

      if ([angleA, distA, angleB, distB, angleC, distC].some(isNaN)) {
        alert("Veuillez remplir tous les champs avec des nombres valides.");
        return;
      }

      const A = polarToCartesian(angleA, distA, unit);
      const B = polarToCartesian(angleB, distB, unit);
      const C = polarToCartesian(angleC, distC, unit);
      const H = projeterPointSurDroite(A, B, C);

      const num = Math.abs((B.y - A.y) * C.x - (B.x - A.x) * C.y + B.x * A.y - B.y * A.x);
      const den = Math.sqrt(Math.pow(B.y - A.y, 2) + Math.pow(B.x - A.x, 2));
      const d = num / den;
      document.getElementById("resultat").textContent = d.toFixed(2);

      dessiner(A, B, C, H);
    }

    function dessiner(A, B, C, H) {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;

      // Calcul du centrage
      const allX = [A.x, B.x, C.x, H.x, 0];
      const allY = [A.y, B.y, C.y, H.y, 0];
      const minX = Math.min(...allX);
      const maxX = Math.max(...allX);
      const minY = Math.min(...allY);
      const maxY = Math.max(...allY);
      const padding = 40;
      const scale = Math.min(
        (width - padding * 2) / (maxX - minX || 1),
        (height - padding * 2) / (maxY - minY || 1)
      );
      const offsetX = (width - (maxX - minX) * scale) / 2 - minX * scale;
      const offsetY = (height - (maxY - minY) * scale) / 2 + maxY * scale;

      function toCanvasCoords(pt) {
        return {
          x: pt.x * scale + offsetX,
          y: offsetY - pt.y * scale
        };
      }

      function drawPoint(pt, color, label) {
        const c = toCanvasCoords(pt);
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(c.x, c.y, 4, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = color;
        ctx.fillText(label, c.x + 6, c.y - 6);
      }

      function drawLine(p1, p2, color, dash = []) {
        const c1 = toCanvasCoords(p1);
        const c2 = toCanvasCoords(p2);
        ctx.strokeStyle = color;
        ctx.setLineDash(dash);
        ctx.beginPath();
        ctx.moveTo(c1.x, c1.y);
        ctx.lineTo(c2.x, c2.y);
        ctx.stroke();
      }

      function drawGrid() {
        ctx.strokeStyle = "#ddd";
        ctx.lineWidth = 1;
        ctx.setLineDash([2, 2]);
        const gridSpacing = 1;
        const step = gridSpacing * scale;
        for (let x = offsetX % step; x < width; x += step) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, height);
          ctx.stroke();
        }
        for (let y = offsetY % step; y < height; y += step) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(width, y);
          ctx.stroke();
        }
      }

      ctx.clearRect(0, 0, width, height);
      drawGrid();
      ctx.lineWidth = 2;

      drawLine(A, B, "black");              // droite AB
      drawLine(C, H, "red", [5, 5]);        // hauteur depuis C
      drawPoint(A, "blue", "A");
      drawPoint(B, "blue", "B");
      drawPoint(C, "green", "C");
      drawPoint(H, "red", "H");
      drawPoint({ x: 0, y: 0 }, "black", "O"); // origine
    }

    function exporterPNG() {
      const canvas = document.getElementById("canvas");
      const image = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      const now = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, "");
      link.download = "distance_point_droite_" + now + ".png";
      link.href = image;
      link.click();
    }
  </script>
</body>
</html>
